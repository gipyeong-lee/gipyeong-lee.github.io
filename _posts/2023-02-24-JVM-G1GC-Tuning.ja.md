---
layout: post
title: "JVM G1GC チューニング"
tags: [jvm, g1gc, tuning]
style: border
color: warning
description: この記事では、JVM G1GC ガベージコレクションアルゴリズムとそのチューニングパラメータの概要を説明します。
lang: ja
ref: 2023-02-24-JVM-G1GC-Tuning
---
# JVM G1GCの概要

Java Virtual Machine (JVM) の Garbage First Garbage Collector (G1GC) は、ガベージコレクションによってアプリケーションが停止する時間を短縮するように設計された、低レイテンシのガベージコレクタです。G1GCはJava 7で導入され、Java 9ではデフォルトのガベージコレクタとなっています。

G1GCはヒープを複数のリージョンに分割することで動作します。各リージョンは固定サイズで、通常1MBから32MBの間です。G1GCはヒープをEden、Survivor、Oldリージョンに分割します。Edenリージョンは、新しいオブジェクトが割り当てられる場所です。Edenリージョンがいっぱいになると、オブジェクトはSurvivorリージョンに移動されます。Survivorリージョンは、1回のガベージコレクションサイクルを生き延びたオブジェクトを保持するために使用されます。Survivorリージョンがいっぱいになると、オブジェクトはOldリージョンに移動されます。Oldリージョンは、複数のガベージコレクションサイクルを生き延びたオブジェクトを保持するために使用されます。

G1GCは並行マーキングアルゴリズムを使用して、どのオブジェクトがまだ使用中であり、どのオブジェクトが再利用可能かを識別します。これにより、G1GCはアプリケーションを停止させることなくオブジェクトを再利用できます。また、G1GCは並行圧縮アルゴリズムを使用してヒープ内のオブジェクトを移動させ、断片化（フラグメンテーション）を減らします。これにより、アプリケーションを停止させることなく、より多くのメモリを再利用できるようになります。

さらに、G1GCは目標停止時間（pause time target）を使用して、ガベージコレクションのためにアプリケーションが停止する時間を制限します。G1GCは停止時間を目標値以下に抑えようとします。停止時間が目標値を超える場合、G1GCは並行マーキングと圧縮に費やす時間を増やすことで、停止時間を短縮しようとします。

G1GCは、ガベージコレクションによる停止時間を最小限に抑える必要があるアプリケーションに適しています。また、G1GCはガベージコレクションの停止時間を短縮するためにチューニングすることも可能です。チューニングパラメータには、リージョンのサイズ、目標停止時間、並行マーキングと圧縮に費やす時間などが含まれます。

# G1GC チューニングパラメータとは？

G1GCチューニングパラメータは、Java Virtual Machine (JVM) におけるG1ガベージコレクタ (G1GC) のパフォーマンスを最適化するための設定です。G1GCは、ガベージコレクションに費やされる時間を削減し、アプリケーションの応答時間を改善するように設計されています。これはヒープをリージョンに分割し、並行してコレクションを行うことで機能します。G1GCチューニングパラメータは、特定のアプリケーションや環境に合わせてG1GCを設定するために使用されます。

## G1GC チューニングパラメータ

G1GCチューニングパラメータは、ヒープサイズパラメータとガベージコレクションパラメータの2つのカテゴリに分類できます。

### ヒープサイズパラメータ

ヒープサイズパラメータは、ヒープのサイズを設定するために使用されます。最も重要なパラメータは以下の通りです。

- `-Xms`: ヒープの初期サイズを設定します。
- `-Xmx`: ヒープの最大サイズを設定します。
- `-XX:MaxGCPauseMillis`: ガベージコレクションの最大停止時間を設定します。

### ガベージコレクションパラメータ

ガベージコレクションパラメータは、ガベージコレクションアルゴリズムを設定するために使用されます。最も重要なパラメータは以下の通りです。

- `-XX:G1HeapRegionSize`: ヒープリージョンのサイズを設定します。
- `-XX:G1ReservePercent`: Old世代オブジェクト用に予約されるヒープの割合を設定します。
- `-XX:G1NewSizePercent`: New世代オブジェクト用に使用されるヒープの割合を設定します。
- `-XX:G1MaxNewSizePercent`: New世代オブジェクト用に使用されるヒープの最大割合を設定します。
- `-XX:G1MixedGCCountTarget`: フルガベージコレクションが発生する前の、混合ガベージコレクション（Mixed GC）の目標回数を設定します。

## 設定例

8GBのRAMを搭載したサーバーで実行されるWebアプリケーション用にG1GCを設定するには、以下のパラメータを使用できます。

```
-Xms4g -Xmx8g -XX:MaxGCPauseMillis=200 -XX:G1HeapRegionSize=4m -XX:G1ReservePercent=10 -XX:G1NewSizePercent=20 -XX:G1MaxNewSizePercent=30 -XX:G1MixedGCCountTarget=4
```

この設定では、初期および最大ヒープサイズを8GBに設定し、ガベージコレクションの最大停止時間を200ミリ秒に設定します。また、ヒープリージョンのサイズを4MB、Old世代オブジェクト用に予約するヒープの割合を10%、New世代オブジェクト用に使用するヒープの割合を20%、New世代オブジェクト用に使用するヒープの最大割合を30%とし、フルガベージコレクション前の混合ガベージコレクションの目標回数を4回に設定しています。

# G1GC パフォーマンスに関する考慮事項

G1ガベージコレクタをチューニングする際、心に留めておくべきいくつかの重要なパフォーマンス上の考慮事項があります。これらには、ヒープサイズ、ガベージコレクションの回数、Survivor領域のサイズ、そしてEden領域のサイズが含まれます。

## ヒープサイズ

ヒープサイズは、G1GCのパフォーマンスにおける重要な要素です。ヒープサイズを大きくするとガベージコレクションの回数は減りますが、その分1回あたりの停止時間が増加する可能性があります。この2つのバランスを適切に見つけることが重要です。

## ガベージコレクションの回数

ガベージコレクションの回数も、G1GCのパフォーマンスにおける重要な要素です。コレクションの回数が多いと1回あたりの停止時間は短縮されますが、ガベージコレクション全体に費やされる総時間は増加する可能性があります。

## Survivor領域

Survivor領域のサイズも、G1GCのパフォーマンスにおいて重要です。Survivor領域を大きくすると、ガベージコレクション中にコピーが必要なオブジェクトの数は減りますが、ガベージコレクションに費やされる時間は増加する可能性があります。

## Eden領域

Eden領域のサイズも、G1GCのパフォーマンスにおいて重要です。Eden領域を大きくすると、ガベージコレクション中にコピーが必要なオブジェクトの数は減りますが、ガベージコレクションに費やされる時間は増加する可能性があります。

## 結論

G1ガベージコレクタのチューニングには、いくつかの重要なパフォーマンス要因を慎重に検討する必要があります。ヒープサイズ、ガベージコレクションの回数、Survivor領域のサイズ、そしてEden領域のサイズはすべて、G1GCをチューニングする際に考慮すべき点です。これらの要因の影響を理解することで、G1GCのパフォーマンスを最適化し、ガベージコレクタが効率的に動作するようにすることができます。
